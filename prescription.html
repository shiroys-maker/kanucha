<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>処方せん</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @media print {
            .print-button-container { display: none !important; }
            body { margin: 0; padding: 0; background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact;}
            .prescription-container-wrapper { padding: 0; background-color: white; }
            .prescription-container {
                margin: 0 auto;
                border: 1px solid black !important; /* 印刷時も枠線は維持したい場合 */
                box-shadow: none;
                width: 100%;
                max-width: 148mm; /* A5幅 */
                height: auto;
                padding: 5mm; /* 印刷時のパディング調整 */
            }
            html, body { height: auto; }
            input[type="text"], textarea { color: black !important; } /* 印刷時の文字色強制 */
        }
        /* 基本フォントとサイズ */
        body { font-family: 'MS Gothic', 'Osaka－等幅', monospace; } /* 等幅フォントを指定 */
        .prescription-container {
            width: 148mm; /* A5 Width */
            min-height: 200mm; /* A5 Height guideline, content will dictate actual */
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border: 1px solid black;
            line-height: 1.3; /* 基本の行間 */
        }
        .form-table { border-collapse: collapse; width: 100%; table-layout: fixed; }
        .form-table td, .form-table th {
            border: 1px solid black;
            padding: 0.5mm 1mm; /* パディングを詰める */
            vertical-align: middle; /* 基本は中央揃え */
            font-size: 7.5pt; /* 全体的にフォントを小さく */
        }
        .form-table td.label-cell { background-color: #f9fafb; /* Tailwind bg-gray-50 */ }
        .form-table input[type="text"], .form-table textarea {
            font-size: 7.5pt; /* input/textarea内のフォントも統一 */
            padding: 0.5mm;
        }
        input[type="text"], input[type="number"], textarea, select {
            border: none; background: transparent; width: 100%; outline: none; color: black;
        }
        textarea { resize: none; overflow-y: hidden; }

        .vertical-text { /* 縦書き共通 */
            writing-mode: vertical-rl;
            text-orientation: upright; /* 文字を正立 */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            letter-spacing: 0.1em;
        }
        .header-title { font-size: 18pt; font-weight: bold; letter-spacing: 0.25em; } /* 字間調整 */
        .sub-header-note { font-size: 6pt; }
        .section-label { font-size: 9pt; font-weight: bold; }
        .data-field { min-height: 1.3em; display: inline-block; vertical-align: bottom; }
        .patient-name-input { font-size: 10pt; font-weight: bold; }
        .doctor-name-span { font-size: 10pt; }
        .seal-box { border: 1px solid black; width: 20mm; height: 20mm; display: flex; align-items: center; justify-content: center; font-size: 8pt; }
        .seal-box-small { border: 1px solid black; width: 7mm; height: 7mm; display:flex; align-items:center; justify-content:center; font-size:6pt; }

    </style>
</head>
<body class="bg-gray-100 p-4 font-mono prescription-container-wrapper">

    <div class="print-button-container text-center my-4">
        <button onclick="window.print()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
            この処方せんを印刷
        </button>
        <button onclick="window.close()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded ml-2">
            閉じる
        </button>
    </div>

    <div class="mx-auto bg-white p-2 prescription-container">

        <div class="text-center mb-1">
            <h1 class="header-title">処　方　せ　ん</h1>
            <p class="sub-header-note mt-0.5">（この処方せんは、どの保険薬局でも有効です。）</p>
        </div>

        <table class="form-table mb-1">
            <colgroup>
                <col style="width: 18%;"><col style="width: 7%;"><col style="width: 7%;"><col style="width: 7%;">
                <col style="width: 7%;"><col style="width: 7%;"><col style="width: 7%;">
                <col style="width: 15%;"><col style="width: 25%;">
            </colgroup>
            <tr>
                <td class="label-cell">公費負担者番号</td>
                <td><input type="text" id="kouhiFutanshaNo1" readonly /></td>
                <td><input type="text" id="kouhiFutanshaNo2" readonly /></td>
                <td class="label-cell text-center" colspan="2">都道府県番号</td>
                <td class="label-cell text-center" colspan="2">医療助番号</td>
                <td class="label-cell">保険者番号</td>
                <td>
                    <div class="flex">
                        <input type="text" id="hokenjaNo1" class="w-1/4" readonly /><input type="text" id="hokenjaNo2" class="w-1/4" readonly /><input type="text" id="hokenjaNo3" class="w-1/4" readonly /><input type="text" id="hokenjaNo4" class="w-1/4" readonly />
                    </div>
                </td>
            </tr>
            <tr>
                <td class="label-cell">公費負担医療の受給者番号</td>
                <td colspan="3"><input type="text" id="kouhiJukyushaNo" readonly /></td>
                <td class="label-cell text-center" colspan="2">（　）</td>
                <td class="label-cell text-center" colspan="1">（　）</td>
                <td class="label-cell">被保険者証・記号番号</td>
                <td><input type="text" id="hihokenshaKigoBango" readonly /></td>
            </tr>
        </table>


        <table class="form-table mb-1">
            <colgroup>
                <col style="width: 5mm;" />
                <col style="width: 20mm;" />
                <col style="width: auto;" />
                <col style="width: 30mm;" />
                <col style="width: auto;" />
            </colgroup>
            <tr>
                <td rowspan="3" class="label-cell patient-label-td">
                    <div class="vertical-text text-base font-semibold">患<br/>者</div>
                </td>
                <td class="label-cell">氏　　　名</td>
                <td><input type="text" id="patientName" class="patient-name-input" readonly /></td>
                <td class="label-cell" style="font-size: 6.5pt;">保険医療機関の所在地及び名称</td>
                <td rowspan="2" style="font-size: 6.5pt; line-height:1.2;"><textarea id="hospitalNameAddress" rows="3" readonly></textarea></td>
            </tr>
            <tr>
                <td class="label-cell">生年月日</td>
                <td class="small-text">
                    <span id="patientDobEra" class="data-field"></span>
                    <span id="patientDobYear" class="data-field w-6 text-right"></span>年
                    <span id="patientDobMonth" class="data-field w-4 text-right"></span>月
                    <span id="patientDobDay" class="data-field w-4 text-right"></span>日生
                    （<span id="patientAge" class="data-field w-3 text-right"></span>才）
                    <span class="ml-2" id="patientSex"></span>
                </td>
                <td class="label-cell">電話番号</td>
            </tr>
            <tr>
                <td class="label-cell">区　　　分</td>
                <td class="small-text">（　）本人 （　）家族</td>
                <td class="label-cell">保険医氏名</td>
                <td class="relative">
                    <div class="text-center">
                        <span id="doctorName" class="data-field doctor-name-span"></span>
                    </div>
                    <div class="absolute right-1 bottom-1 seal-box-small">印</div>
                </td>
            </tr>
        </table>

        <table class="form-table mb-1">
            <colgroup>
                <col style="width: 25mm;" /> <col style="width: auto;" />
                <col style="width: 25mm;" /> <col style="width: auto;" />
                <col style="width: 35%;" />
            </colgroup>
            <tr>
                <td class="label-cell small-text">交付年月日</td>
                <td class="small-text">
                    <span id="issueDateEra" class="data-field"></span>
                    <span id="issueDateYear" class="data-field w-6 text-right"></span>年
                    <span id="issueDateMonth" class="data-field w-4 text-right"></span>月
                    <span id="issueDateDay" class="data-field w-4 text-right"></span>日
                </td>
                <td class="label-cell tiny-text">処方せんの使用期間</td>
                <td class="small-text">
                    <span id="expiryDateEra" class="data-field"></span>
                    <span id="expiryDateYear" class="data-field w-6 text-right"></span>年
                    <span id="expiryDateMonth" class="data-field w-4 text-right"></span>月
                    <span id="expiryDateDay" class="data-field w-4 text-right"></span>日まで
                </td>
                <td class="tiny-text align-top" rowspan="2" style="line-height: 1.2;">
                    特に記載のある場合を除き、交付の日を含めて<span class="font-bold">4日以内</span>に保険薬局に提出すること
                </td>
            </tr>
            <tr>
                <td class="label-cell small-text">保険医コード</td>
                <td class="small-text" colspan="3">（　　　　　　　　　　）</td>
            </tr>
        </table>

        <div class="border-t-2 border-l-2 border-r-2 border-black flex" style="min-height: 80mm;">
            <div class="w-10 label-cell border-r border-black flex items-center justify-center py-1">
                <div class="vertical-text text-lg font-semibold">処方</div>
            </div>
            <div class="flex-1 p-1 data-cell border-r-0">
                <textarea id="prescriptionContent" class="w-full text-sm leading-normal" readonly rows="12"></textarea>
            </div>
        </div>
        <div class="border-l-2 border-r-2 border-black flex" style="min-height: 30mm;">
             <div class="w-10 label-cell border-r border-black flex items-center justify-center py-1">
                <div class="vertical-text text-lg font-semibold">備考</div>
            </div>
            <div class="flex-1 p-1 relative data-cell border-r-0">
                <textarea id="remarksContent" class="w-full text-sm leading-normal" readonly rows="4"></textarea>
                <div class="absolute bottom-1 right-1 tiny-text leading-tight">
                    後発医薬品（ジェネリック医薬品）への変更が<br/>
                    全て不可の場合は、以下に署名又は記名・押印<br/>
                    保険医署名
                </div>
            </div>
        </div>

        <table class="form-table mt-1">
             <colgroup>
                <col style="width: 20mm;" /> <col style="width: auto;" /> <col style="width: 20mm;" />
                <col style="width: auto;" /> <col style="width: 10mm;" /> <col style="width: 25mm;" />
                <col style="width: auto;" />
            </colgroup>
            <tr>
                <td class="label-cell small-text">調剤年月日</td>
                <td><input type="text" readonly/></td>
                <td class="label-cell small-text">公費負担者番号</td>
                <td colspan="4"><input type="text" readonly/></td>
            </tr>
            <tr>
                <td class="label-cell tiny-text" style="height: 12mm; line-height: 1.2;">保険薬局の所在地<br/>及び名称<br/>保険薬剤師氏名</td>
                <td colspan="3">
                    <textarea rows="2" readonly></textarea>
                </td>
                <td class="text-center align-bottom data-cell">
                    <div class="seal-box-small mx-auto">印</div>
                </td>
                <td class="label-cell tiny-text">公費負担医療の<br/>受給者番号</td>
                <td><input type="text" readonly /></td>
            </tr>
        </table>
         <div class="mt-1 tiny-text leading-tight">
            <p><strong>備考</strong> 1.「処方」欄には、薬名、分量、用法及び用量を記載すること。</p>
            <p class="ml-4">2. この様式によれば、1回に処方することができる投薬量は14日分を限度とする。</p>
        </div>
    </div>

<script>
  // JavaScript部分は前回から変更なし（API_ENDPOINTは実際の値にしてください）
  const API_ENDPOINT = "https://us-central1-kanucha-firestore-test.cloudfunctions.net/kanuchaapifirestorenew";

  function isAuthenticated() {
    const auth = localStorage.getItem("auth");
    const expires = parseInt(localStorage.getItem("auth_expire") || "0", 10);
    return auth === "nirai43929" && Date.now() < expires;
  }

  function getFormattedDateParts(dateString) {
    if (!dateString) return { era: '', year: '', month: '', day: '' };
    const date = new Date(dateString);
    let era = '', year = date.getFullYear().toString(), month = (date.getMonth() + 1).toString(), day = date.getDate().toString();
    try {
        const formatter = new Intl.DateTimeFormat('ja-JP-u-ca-japanese', { era: 'short', year: 'numeric' });
        const parts = formatter.formatToParts(date);
        const eraPart = parts.find(p => p.type === "era");
        const yearPart = parts.find(p => p.type === "year");
        if (eraPart) era = eraPart.value;
        if (yearPart) year = yearPart.value;
    } catch (e) {
        console.warn("Japanese era formatting failed, using Western calendar year.", e);
    }
    return { era, year, month, day };
  }

  function calcAge(dobString) {
    if (!dobString) return "";
    const birthDate = new Date(dobString);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age.toString();
  }

  function autoResizeTextarea(element) {
    element.style.height = 'auto';
    const originalOverflow = element.style.overflowY;
    element.style.overflowY = 'hidden';
    element.style.height = (element.scrollHeight) + 'px';
    element.style.overflowY = originalOverflow;
  }


  document.addEventListener("DOMContentLoaded", () => {
    if (!isAuthenticated()) {
      alert("認証されていません。ログインしてください。");
      return;
    }

    const params = new URLSearchParams(window.location.search);
    const patientId = params.get("id");

    document.getElementById("hospitalNameAddress").value = "沖縄県名護市安部１５６−２ Kanucha KIN Clinic\n電話番号: 0980-55-8880";
    document.getElementById("doctorName").innerText = "廣安 俊吾";

    document.getElementById("kouhiFutanshaNo1").value = "";
    document.getElementById("kouhiFutanshaNo2").value = "";
    document.getElementById("kouhiJukyushaNo").value = "";
    document.getElementById("hokenjaNo1").value = "";
    document.getElementById("hokenjaNo2").value = "";
    document.getElementById("hokenjaNo3").value = "";
    document.getElementById("hokenjaNo4").value = "";
    document.getElementById("hihokenshaKigoBango").value = "";

    if (patientId) {
      fetch(API_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          auth: localStorage.getItem("auth"),
          action: "getById",
          id: patientId
        })
      })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(patient => {
        console.log("取得データ (Firestore):", patient);
        if (patient.error) throw new Error(patient.error);

        document.getElementById("patientName").value = patient.名前 || '';
        document.getElementById("patientSex").innerText = patient.性別 || '';

        const dobParts = getFormattedDateParts(patient.生年月日);
        document.getElementById("patientDobEra").innerText = dobParts.era;
        document.getElementById("patientDobYear").innerText = dobParts.year;
        document.getElementById("patientDobMonth").innerText = dobParts.month;
        document.getElementById("patientDobDay").innerText = dobParts.day;
        document.getElementById("patientAge").innerText = calcAge(patient.生年月日);

        const todayParts = getFormattedDateParts(new Date().toISOString().split("T")[0]);
        document.getElementById("issueDateEra").innerText = todayParts.era;
        document.getElementById("issueDateYear").innerText = todayParts.year;
        document.getElementById("issueDateMonth").innerText = todayParts.month;
        document.getElementById("issueDateDay").innerText = todayParts.day;

        const expiry = new Date();
        expiry.setDate(expiry.getDate() + 3);
        const expiryParts = getFormattedDateParts(expiry.toISOString().split("T")[0]);
        document.getElementById("expiryDateEra").innerText = expiryParts.era;
        document.getElementById("expiryDateYear").innerText = expiryParts.year;
        document.getElementById("expiryDateMonth").innerText = expiryParts.month;
        document.getElementById("expiryDateDay").innerText = expiryParts.day;

        let formattedPrescription = "";
        if (patient.投薬内容) {
            const lines = patient.投薬内容.split(/\n|\\n/);
            lines.forEach((line) => {
                if (line.trim() !== "") {
                    formattedPrescription += `${line.trim()}\n`;
                }
            });
        }
        const prescriptionTextarea = document.getElementById("prescriptionContent");
        prescriptionTextarea.value = formattedPrescription.trim() || '記載なし';
        autoResizeTextarea(prescriptionTextarea);

        const remarksTextarea = document.getElementById("remarksContent");
        remarksTextarea.value = patient.備考 || '';
        autoResizeTextarea(remarksTextarea);
      })
      .catch(error => {
          console.error("患者データの読み込みに失敗しました:", error);
          alert("患者データの読み込みに失敗しました: " + error.message);
          document.getElementById("prescriptionContent").value = "エラー: 患者データを読み込めませんでした。";
      });
    } else {
      alert("患者IDが指定されていません。");
      document.getElementById("prescriptionContent").value = "患者IDが指定されていません。";
    }
  });
</script>
</body>
</html>