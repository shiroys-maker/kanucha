<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>患者情報編集</title>
<script>
  const loginTime = localStorage.getItem("kanuchaLogin");
  const now = Date.now();
  if (!loginTime || now - parseInt(loginTime) > 10 * 60 * 1000) {
    localStorage.removeItem("kanuchaLogin");
    window.location.href = "login.html";
  } else {
    localStorage.setItem("kanuchaLogin", Date.now().toString());
  }
</script>
<style>
body {
  font-family: Arial, sans-serif;
  padding: 20px;
  background: #f3f8fb;
}
.container {
  max-width: 800px;
  margin: auto;
  background: white;
  padding: 24px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 {
  margin-top: 0;
}
input, textarea, select {
  width: 100%;
  padding: 8px;
  margin-bottom: 12px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 4px;
}
label {
  font-weight: bold;
}
button {
  padding: 10px 16px;
  background: #007acc;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover {
  background: #005fa3;
}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc
} from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoCiWXT9A8ndxEAKYHx-Vnog_92G9T3k8",
  authDomain: "kanucha-api.firebaseapp.com",
  projectId: "kanucha-api",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const params = new URLSearchParams(window.location.search);
const patientId = params.get("id");

if (patientId) {
  const ref = doc(db, "patients", patientId);
  getDoc(ref).then((docSnap) => {
    if (docSnap.exists()) {
      const data = docSnap.data();
      for (const key in data) {
        const field = document.getElementById(key);
        if (field) {
          field.value = data[key];
        }
      }
      calculateAge(); // 編集時も年齢計算
    }
  });
}

document.getElementById("birthdate").addEventListener("change", calculateAge);
document.getElementById("visitDate").addEventListener("change", calculateAge);

function calculateAge() {
  const birth = new Date(document.getElementById("birthdate").value);
  const visit = new Date(document.getElementById("visitDate").value || new Date());
  let age = visit.getFullYear() - birth.getFullYear();
  const m = visit.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && visit.getDate() < birth.getDate())) {
    age--;
  }
  document.getElementById("age").value = age;
}

document.getElementById("patientForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = new FormData(e.target);
  const data = {};
  form.forEach((v, k) => data[k] = v);
  await setDoc(doc(db, "patients", data.id), data);
  alert("保存しました");
  window.location.href = "list.html";
});
</script>
</head>
<body>
<div class="container">
  <h1>患者情報</h1>
  <form id="patientForm">
    <label>ID</label><input type="text" id="id" name="id" required />
    <label>名前</label><input type="text" id="名前" name="名前" required />
    <label>生年月日</label><input type="date" id="birthdate" name="生年月日" required />
    <label>性別</label>
    <select id="性別" name="性別">
      <option value="男性">男性</option>
      <option value="女性">女性</option>
    </select>
    <label>受診日</label><input type="date" id="visitDate" name="受診日" required />
    <label>年齢</label><input type="number" id="age" name="年齢" readonly />
    <label>血圧</label><input type="text" id="血圧" name="血圧" />
    <label>脈</label><input type="text" id="脈" name="脈" />
    <label>体温</label><input type="text" id="体温" name="体温" />
    <label>SAT</label><input type="text" id="SAT" name="SAT" />
    <label>来院の目的</label><textarea id="来院の目的" name="来院の目的"></textarea>
    <label>既往歴</label><textarea id="既往歴" name="既往歴"></textarea>
    <label>内服薬</label><textarea id="内服薬" name="内服薬"></textarea>
    <label>アレルギー</label><textarea id="アレルギー" name="アレルギー"></textarea>
    <label>診察所見</label><textarea id="診療所見" name="診療所見"></textarea>
    <label>診断名</label><input type="text" id="診断名" name="診断名" />
    <label>投薬内容</label><textarea id="投薬内容" name="投薬内容"></textarea>
    <label>備考</label><textarea id="備考" name="備考"></textarea>
    <button type="submit">保存</button>
  </form>
</div>
</body>
</html>