<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>患者フォーム</title>
<script>
  const loginTime = localStorage.getItem("kanuchaLogin");
  const now = Date.now();
  if (!loginTime || now - parseInt(loginTime) > 10 * 60 * 1000) {
    localStorage.removeItem("kanuchaLogin");
    window.location.href = "login.html";
  }
</script>
<style>
  body {
    font-family: 'Helvetica Neue', sans-serif;
    background: #eef5f9;
    padding: 24px;
    color: #333;
  }
  .card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    max-width: 900px;
    margin: auto;
  }
  button, a.button {
    background: #007acc;
    color: white;
    padding: 8px 16px;
    font-size: 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    margin: 5px;
  }
  button:hover, a.button:hover {
    background: #005fa3;
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 12px;
  }
  .short-input { width: 100px; }
  textarea { width: 100%; }
  .double-height { height: 120px; }
</style>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoCiWXT9A8ndxEAKYHx-Vnog_92G9T3k8",
    authDomain: "kanucha-api.firebaseapp.com",
    projectId: "kanucha-api",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  document.addEventListener("DOMContentLoaded", async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    const form = document.getElementById("form");

    const calcAge = (dob) => {
      const birth = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
      return age;
    };

    const dobInput = form["生年月日"];
    const ageInput = form["年齢"];
    if (dobInput && ageInput) {
      dobInput.addEventListener("change", () => {
        ageInput.value = calcAge(dobInput.value);
      });
    }

    const visitInput = form["受診日"];
    if (visitInput && !visitInput.value) {
      visitInput.value = new Date().toISOString().split("T")[0];
    }

    if (id) {
      const docRef = doc(db, "patients", id);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        for (const key in data) {
          const el = form.querySelector(`[name='${key}']`);
          if (el) el.value = data[key];
        }
        ageInput.value = calcAge(data["生年月日"]);
        document.getElementById("printLink").href = `print-from-api.html?id=${id}`;
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = {};
      new FormData(form).forEach((value, key) => formData[key] = value);
      if (formData["生年月日"]) formData["年齢"] = calcAge(formData["生年月日"]);
      await setDoc(doc(db, "patients", formData.id || crypto.randomUUID()), formData);
      alert("保存しました");
      location.href = "list.html";
    });
  });
</script>
</head>
<body>
<div class="card">
<h2>患者情報</h2>
<form id="form">
<div class="row">
        ID: <input name="id" required/>
        名前: <input name="名前"/>
        生年月日: <input name="生年月日" type="date"/>
        性別:
        <select name="性別"><option>男性</option><option>女性</option></select>
        年齢: <input class="short-input" disabled name="年齢"/>
</div>
<div class="row">
        受診日: <input class="short-input" name="受診日" type="date"/>
</div>
<div class="row">
        血圧: <input class="short-input" name="血圧"/>
        脈: <input class="short-input" name="脈"/>
        体温: <input class="short-input" name="体温"/>
        SAT: <input class="short-input" name="SAT"/>
</div>
<div>来院の目的 (看護師入力): <textarea class="double-height" name="来院の目的"></textarea></div>
<div>既往歴: <textarea name="既往歴" rows="4"></textarea></div>
<div>内服薬: <textarea name="内服薬" rows="4"></textarea></div>
<div>アレルギー: <textarea name="アレルギー"></textarea></div>
<div>診察所見 (医師入力): <textarea class="double-height" name="診察所見"></textarea></div>
<div>診断名: <textarea name="診断名"></textarea></div>
<div>投薬内容: <textarea class="double-height" name="投薬内容"></textarea></div>
<div>備考: <textarea name="備考"></textarea></div>
<div class="row">
<button type="submit">更新</button>
<button type="button" onclick="location.href='list.html'">一覧に戻る</button>
<a class="button" href="#" id="printLink" target="_blank">印刷</a>
</div>
</form>
</div>
</body>
</html>