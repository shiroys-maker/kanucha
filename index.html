
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>患者フォーム</title>
<style>
    
  body {
    font-family: 'Helvetica Neue', sans-serif;
    background: #eef5f9;
    padding: 24px;
    color: #333;
  }

  .card {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    max-width: 900px;
    margin: auto;
  }

  button, a.button {
    background: #007acc;
    color: white;
    padding: 8px 16px;
    font-size: 15px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    margin: 5px;
  }

  button:hover, a.button:hover {
    background: #005fa3;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
  }

  th {
    background: #d9ecf7;
  }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .short-input { width: 100px; }
    textarea { width: 100%; }
    .double-height { height: 120px; }
  </style>
<script>
function calcAge(birthday) {
  if (!birthday) return "";
  const today = new Date();
  const birth = new Date(birthday);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
    age--;
  }
  return age;
}

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const headers = ["id", "名前", "生年月日", "性別", "年齢", "受診日", "血圧", "脈", "体温", "SAT", "来院の目的", "既往歴", "内服薬", "アレルギー", "診察所見", "診断名", "投薬内容", "備考"];
    const data = {};
    headers.forEach(key => {
      data[key] = formData.get(key) || "";
    });

    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...data
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });
<script>
document.addEventListener("DOMContentLoaded", function() {
  // 年齢自動計算
  const birthdayInput = document.querySelector('[name="生年月日"]');
  const ageInput = document.querySelector('[name="年齢"]');
  if (birthdayInput && ageInput) {
    birthdayInput.addEventListener("change", function() {
      ageInput.value = calcAge(birthdayInput.value);
    });
  }

  // 受診日を本日の日付に設定
  const visitDateInput = document.querySelector('[name="受診日"]');
  if (visitDateInput && !visitDateInput.value) {
    const today = new Date().toISOString().split("T")[0];
    visitDateInput.value = today;
  }
});

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const headers = ["id", "名前", "生年月日", "性別", "年齢", "受診日", "血圧", "脈", "体温", "SAT", "来院の目的", "既往歴", "内服薬", "アレルギー", "診察所見", "診断名", "投薬内容", "備考"];
    const data = {};
    headers.forEach(key => {
      data[key] = formData.get(key) || "";
    });

    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...data
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });
</head>
<body>
<script>
    if (localStorage.getItem("auth") !== "nirai43929") {
      location.href = "login.html";
    }
  
  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const headers = ["id", "名前", "生年月日", "性別", "年齢", "受診日", "血圧", "脈", "体温", "SAT", "来院の目的", "既往歴", "内服薬", "アレルギー", "診察所見", "診断名", "投薬内容", "備考"];
    const data = {};
    headers.forEach(key => {
      data[key] = formData.get(key) || "";
    });

    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...data
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });

<div class="card">
<h2>患者情報</h2>
<form id="form">
<div class="row">
        ID: <input name="id" required=""/>
        名前: <input name="名前"/>
        生年月日: <input name="生年月日" type="date"/>
        性別:
        <select name="性別"><option>男性</option><option>女性</option></select>
        年齢: <input class="short-input" disabled="" name="年齢"/>
</div>
<div class="row">
        受診日: <input class="short-input" name="受診日" type="date"/>
</div>
<div class="row">
        血圧: <input class="short-input" name="血圧"/>
        脈: <input class="short-input" name="脈"/>
        体温: <input class="short-input" name="体温"/>
        SAT: <input class="short-input" name="SAT"/>
</div>
<div>来院の目的: <textarea class="double-height" name="来院の目的"></textarea></div>
<div>既往歴: <textarea class="normal-height" name="既往歴" rows="4"></textarea></div>
<div>内服薬: <textarea class="normal-height" name="内服薬" rows="4"></textarea></div>
<div>アレルギー: <textarea class="normal-height" name="アレルギー"></textarea></div>
<div>診察所見: <textarea class="double-height" name="診察所見"></textarea></div>
<div>診断名: <textarea class="normal-height" name="診断名"></textarea></div>
<div>投薬内容: <textarea class="double-height" name="投薬内容"></textarea></div>
<div>備考: <textarea class="normal-height" name="備考"></textarea></div>
<div class="row">
<button type="submit">更新</button>
<button onclick="location.href='list.html'" type="button">一覧に戻る</button>
<a class="button" href="#" id="printLink" target="_blank">印刷</a>
</div>
</form>
</div>
<script>
const urlParams = new URLSearchParams(window.location.search);
const id = urlParams.get("id");

if (id) {
  fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      auth: localStorage.getItem("auth"),
      action: "getById",
      id: id
    })
  })
  .then(res => res.json())
  .then(data => {
    for (const name in data) {
      if (form[name]) form[name].value = data[name];
    }
    form["年齢"].value = calcAge(data["生年月日"]);
    document.getElementById("printLink").href = `print-from-api.html?id=${data.id}`;
  });
}

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const headers = ["id", "名前", "生年月日", "性別", "年齢", "受診日", "血圧", "脈", "体温", "SAT", "来院の目的", "既往歴", "内服薬", "アレルギー", "診察所見", "診断名", "投薬内容", "備考"];
    const data = {};
    headers.forEach(key => {
      data[key] = formData.get(key) || "";
    });

    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...data
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });

<script>
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id");
  const form = document.querySelector("form");

  const calcAge = (dob) => {
    const birth = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
  };

  const dobInput = document.getElementById("生年月日");
  const ageInput = document.getElementById("年齢");
  if (dobInput && ageInput) {
    dobInput.addEventListener("change", () => {
      ageInput.value = calcAge(dobInput.value);
    });
  }

  const visitDateInput = document.getElementById("受診日");
  if (visitDateInput) {
    visitDateInput.value = new Date().toISOString().split("T")[0];
  }

  if (id) {
    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "getById",
        id: id
      })
    })
    .then(res => res.json())
    .then(data => {
      for (const name in data) {
        if (form[name]) form[name].value = data[name];
      }
      if (dobInput && ageInput) {
        ageInput.value = calcAge(dobInput.value);
      }
    });
  }

  
});

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const headers = ["id", "名前", "生年月日", "性別", "年齢", "受診日", "血圧", "脈", "体温", "SAT", "来院の目的", "既往歴", "内服薬", "アレルギー", "診察所見", "診断名", "投薬内容", "備考"];
    const data = {};
    headers.forEach(key => {
      data[key] = formData.get(key) || "";
    });

    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...data
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });

</body>
</html>

document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get("id");
  const form = document.querySelector("form");

  const calcAge = (dob) => {
    const birth = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
  };

  const dobInput = document.getElementById("生年月日");
  const ageInput = document.getElementById("年齢");
  if (dobInput && ageInput) {
    dobInput.addEventListener("change", () => {
      ageInput.value = calcAge(dobInput.value);
    });
  }

  const visitInput = document.getElementById("受診日");
  if (visitInput && !visitInput.value) {
    visitInput.value = new Date().toISOString().split("T")[0];
  }

  if (id) {
    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "getById",
        id: id
      })
    })
    .then(res => res.json())
    .then(data => {
      for (const key in data) {
        const el = form.querySelector(`[name='${key}']`);
        if (el) el.value = data[key];
      }
      if (dobInput && ageInput) {
        ageInput.value = calcAge(dobInput.value);
      }
    });
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const obj = Object.fromEntries(new FormData(form));
    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "add",
        ...obj
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("保存しました");
      location.href = "list.html";
    })
    .catch(() => alert("保存に失敗しました"));
  });
});
</script>
</head><script>
document.addEventListener("DOMContentLoaded", () => {
  const birthInput = document.getElementById("birth");
  const ageInput = document.getElementById("age");
  const visitInput = document.getElementById("visit");

  // 年齢自動計算
  birthInput.addEventListener("change", () => {
    const birthDate = new Date(birthInput.value);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    ageInput.value = age;
  });

  // 受診日 初期値（既存値がなければ本日）
  if (!visitInput.value) {
    const today = new Date().toISOString().split("T")[0];
    visitInput.value = today;
  }
});
</script></html>