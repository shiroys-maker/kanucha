<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>患者情報編集</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
    }
    label {
      display: block;
      margin-top: 1em;
    }
    input, select {
      font-size: 1em;
      padding: 0.2em;
    }
  </style>
</head>
<body>
  <h1>患者情報</h1>
  <form id="patientForm">
    <label>ID: <input type="text" id="id" readonly></label>
    <label>名前: <input type="text" id="name"></label>
    <label>生年月日: <input type="date" id="birth"></label>
    <label>性別:
      <select id="gender">
        <option value="男性">男性</option>
        <option value="女性">女性</option>
      </select>
    </label>
    <label>年齢: <input type="text" id="age" readonly></label>
    <label>受診日: <input type="date" id="visitDate"></label>
    <label>血圧: <input type="text" id="bp"></label>
    <label>脈: <input type="text" id="pulse"></label>
    <label>体温: <input type="text" id="temp"></label>
    <label>SAT: <input type="text" id="sat"></label>
    <label>来院の目的: <input type="text" id="purpose"></label>
    <label>既往歴: <textarea id="history"></textarea></label>
    <label>内服薬: <textarea id="meds"></textarea></label>
    <label>アレルギー: <input type="text" id="allergy"></label>
    <label>診察所見: <textarea id="findings"></textarea></label>
    <label>診断名: <input type="text" id="diagnosis"></label>
    <label>投薬内容: <input type="text" id="treatment"></label>
    <label>備考: <input type="text" id="remarks"></label>
    <button type="submit">保存</button>
  </form>

  <script>
    const form = document.getElementById('patientForm');
    const id = new URLSearchParams(window.location.search).get('id');

    const calcAge = (birthStr) => {
      const birth = new Date(birthStr);
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      return age;
    }

    const fillForm = async () => {
      const res = await fetch(`https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi?id=${id}`);
      const json = await res.json();
      const d = json.data;

      document.getElementById('id').value = d[0];
      document.getElementById('name').value = d[1];
      document.getElementById('birth').value = d[2];
      document.getElementById('gender').value = d[3];
      document.getElementById('age').value = d[4];
      document.getElementById('visitDate').value = d[5];
      document.getElementById('bp').value = d[6];
      document.getElementById('pulse').value = d[7];
      document.getElementById('temp').value = d[8];
      document.getElementById('sat').value = d[9];
      document.getElementById('purpose').value = d[10];
      document.getElementById('history').value = d[11];
      document.getElementById('meds').value = d[12];
      document.getElementById('allergy').value = d[13];
      document.getElementById('findings').value = d[14];
      document.getElementById('diagnosis').value = d[15];
      document.getElementById('treatment').value = d[16];
      document.getElementById('remarks').value = d[17];
    }

    document.getElementById('birth').addEventListener('change', (e) => {
      document.getElementById('age').value = calcAge(e.target.value);
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = [
        form.id.value,
        form.name.value,
        form.birth.value,
        form.gender.value,
        form.age.value,
        form.visitDate.value,
        form.bp.value,
        form.pulse.value,
        form.temp.value,
        form.sat.value,
        form.purpose.value,
        form.history.value,
        form.meds.value,
        form.allergy.value,
        form.findings.value,
        form.diagnosis.value,
        form.treatment.value,
        form.remarks.value,
      ];

      const res = await fetch('https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ type: 'update', id: data[0], data }),
      });

      const result = await res.json();
      alert(result.message || '保存しました');
    });

    fillForm();
  </script>
</body>
</html>