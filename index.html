<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>患者フォーム</title>
</head>
<body>
  <button onclick="location.href='list.html'">一覧に戻る</button>
  <form id="form">
    ID: <input name="id" required><br>
    名前: <input name="名前"><br>
    生年月日: <input name="生年月日" type="date"><br>
    性別: <select name="性別"><option>男性</option><option>女性</option></select><br>
    受診日: <input name="受診日" type="date"><br>
    年齢: <input name="年齢" disabled><br>
    血圧: <input name="血圧"><br>
    脈: <input name="脈"><br>
    体温: <input name="体温"><br>
    SAT: <input name="SAT"><br>
    来院の目的: <textarea name="来院の目的"></textarea><br>
    既往歴: <textarea name="既往歴"></textarea><br>
    内服薬: <textarea name="内服薬"></textarea><br>
    アレルギー: <textarea name="アレルギー"></textarea><br>
    診察所見: <textarea name="診察所見"></textarea><br>
    診断名: <textarea name="診断名"></textarea><br>
    投薬内容: <textarea name="投薬内容"></textarea><br>
    備考: <textarea name="備考"></textarea><br>
    <button type="submit">更新</button>
  </form>

  <script>
    const form = document.forms[0];
    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    // 年齢自動計算
    form["生年月日"].addEventListener("change", () => {
      const birth = new Date(form["生年月日"].value);
      const age = new Date().getFullYear() - birth.getFullYear();
      form["年齢"].value = age;
    });

    if (id) {
      fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaapi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "getById", id })
      })
      .then(res => res.json())
      .then(data => {
        for (const name in data) {
          if (form[name]) form[name].value = data[name];
        }
      });
    } else {
      // デフォルトで本日の日付を受診日に設定
      form["受診日"].valueAsDate = new Date();
    }

    form.addEventListener("submit", e => {
      e.preventDefault();
      const obj = Object.fromEntries(new FormData(form));
      obj.action = "add";
      fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaapi", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(obj)
      })
      .then(res => res.json())
      .then(() => {
        alert("保存しました");
        location.href = "list.html";
      });
    });
  </script>
</body>
</html>