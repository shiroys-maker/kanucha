<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>患者一覧</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
      }
      h1 {
        text-align: center;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
        word-wrap: break-word;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 4px;
        text-align: center;
        font-size: 12px;
      }
      th:nth-child(3),
      td:nth-child(3) {
        width: 60px;
      }
      th:nth-child(4),
      td:nth-child(4) {
        width: 50px;
      }
      th:nth-child(5),
      td:nth-child(5) {
        width: 90px;
      }
      th:nth-child(6),
      td:nth-child(6) {
        width: 90px;
      }
      a.button,
      button {
        padding: 2px 5px;
        margin: 1px;
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <h1>患者一覧</h1>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>名前</th>
          <th>性別</th>
          <th>年齢</th>
          <th>受診日</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody>
        <!-- レコードがここに追加されます -->
      </tbody>
    </table>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        deleteDoc,
        doc
      } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyBoCiWXT9A8ndxEAKYHx-Vnog_92G9T3k8",
        authDomain: "kanucha-api.firebaseapp.com",
        projectId: "kanucha-api",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      document.addEventListener("DOMContentLoaded", () => {
        const tbody = document.querySelector("tbody");

        function calculateAge(birthdateStr, visitDateStr) {
          const birthdate = new Date(birthdateStr);
          const visitDate = visitDateStr ? new Date(visitDateStr) : new Date();
          let age = visitDate.getFullYear() - birthdate.getFullYear();
          const m = visitDate.getMonth() - birthdate.getMonth();
          if (m < 0 || (m === 0 && visitDate.getDate() < birthdate.getDate())) {
            age--;
          }
          return age;
        }

        function loadPatients() {
          getDocs(collection(db, "patients"))
            .then(snapshot => {
              tbody.innerHTML = "";
              snapshot.forEach(docSnap => {
                const row = docSnap.data();
                const age = calculateAge(row['生年月日'], row['受診日']);
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${row.id || ''}</td>
                  <td>${row.名前 || ''}</td>
                  <td>${row.性別 || ''}</td>
                  <td>${age}</td>
                  <td>${row.受診日 || ''}</td>
                  <td>
                    <a class="button" href="index.html?id=${row.id}">編集</a>
                    <button class="delete-btn" onclick="deletePatient('${docSnap.id}')">削除</button>
                  </td>
                `;
                tbody.appendChild(tr);
              });
            });
        }

        window.deletePatient = function(id) {
          if (!confirm("本当に削除しますか？")) return;
          deleteDoc(doc(db, "patients", id))
            .then(() => {
              alert("削除しました");
              loadPatients();
            })
            .catch(() => alert("削除に失敗しました"));
        };

        loadPatients();
      });
    </script>
  </body>
</html>