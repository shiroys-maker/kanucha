
<!DOCTYPE html>

<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>患者一覧</title>
<style>
body {
  font-family: 'Helvetica Neue', sans-serif;
  background: #eef5f9;
  padding: 24px;
  color: #333;
  margin: 0;
}

.container {
  max-width: 100%;
  margin: auto;
}

.card {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

button, a.button {
  background: #007acc;
  color: white;
  padding: 8px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
  margin: 5px;
}

button:hover, a.button:hover {
  background: #005fa3;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}

th, td {
  border: 1px solid #999;
  padding: 10px;
  text-align: left;
  word-wrap: break-word;
}

th {
  background: #d9ecf7;
}

.delete-btn {
  color: white;
  background-color: red;
  border: none;
  border-radius: 4px;
  padding: 4px 10px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="container card"><div style="text-align: right;"><button onclick="logout()">ログアウト</button></div>
<h1>患者一覧</h1>
<button onclick="location.href='index.html'">新規登録</button>
<table id="patientTable">
<thead>
<tr>
<th>ID</th>
<th>名前</th>
<th>性別</th>
<th>年齢</th>
<th>受診日</th>
<th>操作</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>


<script>
  function isAuthenticated() {
    const auth = localStorage.getItem("auth");
    const expires = parseInt(localStorage.getItem("auth_expire") || "0", 10);
    return auth === "nirai43929" && Date.now() < expires;
  }

  if (!isAuthenticated()) {
    location.href = "login.html";
  }

  const tbody = document.querySelector("tbody");

  function loadPatients() {
    console.log("loadPatients関数を呼び出します");
    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "get"
      })
    })
    .then(res => {
      console.log("レスポンスステータス:", res.status);
      return res.json();
    })
    .then(data => {
      console.log("取得データ:", data);
      tbody.innerHTML = "";
      for (const row of data) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${row.名前}</td>
          <td>${row.性別}</td>
          <td>${row.年齢}</td>
          <td>${row.受診日}</td>
          <td>
            <a class="button" href="index.html?id=${row.id}">編集</a>
            <button class="delete-btn" onclick="deletePatient('${row.id}')">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    });
  }

  function deletePatient(id) {
    if (!confirm("本当に削除しますか？")) return;
    fetch("https://us-central1-kanucha-api.cloudfunctions.net/kanuchaApi", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        auth: localStorage.getItem("auth"),
        action: "delete",
        id: id
      })
    })
    .then(res => res.json())
    .then(() => {
      alert("削除しました");
      loadPatients();
    })
    .catch(() => alert("削除に失敗しました"));
  }

  console.log("初期化: loadPatients を呼び出します");
  loadPatients();
</script>
</body>
</html>
